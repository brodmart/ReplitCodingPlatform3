<!DOCTYPE html>
<html>
<head>
    <title>Interactive C# Code Editor</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css">
    <style>
        .editor-console-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .editor-section, .console-section {
            flex: 1;
            min-width: 0;
        }
        .editor-container {
            height: 400px;
            border: 1px solid #2d2d2d;
        }
        #terminal-container {
            height: 400px;
            background-color: #1e1e1e;
            border: 1px solid #2d2d2d;
            border-radius: 4px;
            padding: 8px;
        }
        .CodeMirror {
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">Interactive C# Console</h1>
                <div class="editor-console-container">
                    <div class="editor-section">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <select id="languageSelect" class="form-select w-auto">
                                    <option value="csharp" selected>C#</option>
                                </select>
                                <button id="runButton" class="btn btn-primary">
                                    <i class="bi bi-play-fill"></i> Run
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="editor-container">
                                    <textarea id="editor">using System;

class Program
{
    static void Main()
    {
        Console.WriteLine("Hello! Please enter your name:");
        string name = Console.ReadLine();
        Console.WriteLine($"Nice to meet you, {name}!");
    }
}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="console-section">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Console</span>
                                <button id="clearConsole" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="terminal-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Socket.IO first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- Load CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>

    <!-- Load Xterm.js and its addons -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-search@0.11.0/lib/xterm-addon-search.js"></script>

    <!-- Load our scripts -->
    <script src="{{ url_for('static', filename='js/console.js') }}"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Initialize CodeMirror
            const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                mode: 'text/x-csharp',
                theme: 'dracula',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                viewportMargin: Infinity
            });

            // Initialize console with terminal container
            const consoleInstance = new InteractiveConsole({
                terminalContainer: 'terminal-container'
            });

            // Run button handler
            document.getElementById('runButton').addEventListener('click', () => {
                const code = editor.getValue();
                consoleInstance.compileAndRun(code);
            });

            // Clear button handler
            document.getElementById('clearConsole').addEventListener('click', () => {
                consoleInstance.clear();
            });

        } catch (error) {
            console.error('Failed to initialize components:', error);
            const terminalContainer = document.getElementById('terminal-container');
            if (terminalContainer) {
                terminalContainer.innerHTML = `<div class="alert alert-danger">Failed to initialize console: ${error.message}</div>`;
            }
        }
    });
    </script>
</body>
</html>