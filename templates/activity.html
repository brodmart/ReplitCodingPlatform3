{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="editor-console-row">
                    <div class="editor-column">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Code Editor</h5>
                                    <div class="d-flex gap-2">
                                        <button id="runButton" class="btn btn-primary">
                                            <i class="bi bi-play-fill"></i> Run
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="editor-container">
                                    <textarea id="editor">{{ activity.starter_code or '// Your code here' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="console-column">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Interactive Console</h5>
                                    <button id="clearConsole" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="console-container">
                                    <div id="consoleOutput"></div>
                                    <div class="console-input-line">
                                        <span class="console-prompt">&gt;</span>
                                        <input type="text" id="consoleInput" 
                                               placeholder="Press Enter to send"
                                               autocomplete="off"
                                               spellcheck="false">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO must be loaded first -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- Then load our console implementation -->
<script src="{{ url_for('static', filename='js/console.js') }}"></script>

<!-- Initialize console -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing activity page...');

    try {
        // Create console instance
        window.consoleInstance = new InteractiveConsole();
        console.log('Console instance created');

        // Setup run button
        const runButton = document.getElementById('runButton');
        if (runButton) {
            runButton.addEventListener('click', () => {
                const code = document.getElementById('editor').value;
                console.log('Run button clicked, executing code');
                window.consoleInstance.compileAndRun(code);
            });
        }

        // Setup clear button
        const clearButton = document.getElementById('clearConsole');
        if (clearButton) {
            clearButton.addEventListener('click', () => {
                console.log('Clear button clicked');
                window.consoleInstance.clear();
            });
        }

        // Load editor after console is ready
        const editorScript = document.createElement('script');
        editorScript.src = "{{ url_for('static', filename='js/editor.js') }}";
        document.body.appendChild(editorScript);

    } catch (error) {
        console.error('Failed to initialize:', error);
        const output = document.getElementById('consoleOutput');
        if (output) {
            output.innerHTML = `<div class="console-error">Initialization failed: ${error.message}</div>`;
        }
    }
});
</script>
{% endblock %}