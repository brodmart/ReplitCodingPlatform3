{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<style>
    /* Editor Styles */
    .editor-container {
        height: 400px;
        border: 1px solid #2d2d2d;
        margin-bottom: 20px;
    }

    #editor {
        width: 100%;
        height: 100%;
    }

    /* Console Styles */
    .console-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 14px;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        border: 1px solid #2d2d2d;
        border-radius: 4px;
    }

    .console-output {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        min-height: 200px;
        background-color: #1e1e1e;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .console-input-wrapper {
        display: flex;
        padding: 8px;
        background-color: #2d2d2d;
        border-top: 1px solid #3d3d3d;
    }

    .console-input {
        flex-grow: 1;
        background-color: transparent;
        border: none;
        color: #d4d4d4;
        font-family: inherit;
        font-size: inherit;
        padding: 4px 8px;
        outline: none;
    }

    .console-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-message {
        color: #ff5555;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Editor Column -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Code Editor</h5>
                        <button id="runButton" class="btn btn-primary">
                            <i class="bi bi-play-fill"></i> Run
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="editor-container">
                        <textarea id="editor">// Your C# code here
using System;

class Program
{
    static void Main()
    {
        Console.WriteLine("Enter your name:");
        string name = Console.ReadLine();
        Console.WriteLine($"Hello, {name}!");
    }
}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Column -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Console</h5>
                        <button id="clearConsole" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="console-container">
                        <div id="consoleOutput" class="console-output"></div>
                        <div class="console-input-wrapper">
                            <input type="text" id="consoleInput" 
                                   class="console-input"
                                   placeholder="Press Enter to send"
                                   disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Socket.IO first -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>

<!-- Load our console implementation -->
<script src="{{ url_for('static', filename='js/console.js') }}"></script>

<!-- Initialize console -->
<script>
// Wait for all resources to load
window.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'text/x-csharp',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            viewportMargin: Infinity
        });

        // Create console instance
        window.consoleInstance = new InteractiveConsole();

        // Setup run button
        const runButton = document.getElementById('runButton');
        if (runButton) {
            runButton.addEventListener('click', () => {
                const code = editor.getValue();
                window.consoleInstance.compileAndRun(code);
            });
        }

        // Setup clear button
        const clearButton = document.getElementById('clearConsole');
        if (clearButton) {
            clearButton.addEventListener('click', () => {
                window.consoleInstance.clear();
            });
        }
    } catch (error) {
        console.error('Failed to initialize console:', error);
        const consoleOutput = document.getElementById('consoleOutput');
        if (consoleOutput) {
            consoleOutput.innerHTML = `<div class="error-message">Console initialization failed: ${error.message}</div>`;
        }
    }
});
</script>
{% endblock %}