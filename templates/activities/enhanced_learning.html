{% extends "base.html" %}

{% block head %}
<!-- Required CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

<!-- Add CSRF token meta tag -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<meta name="interface-lang" content="{{ lang }}">

<style>
    .editor-container {
        width: 100%;
        height: 400px;
        position: relative;
        margin: 0;
        padding: 0;
    }

    .CodeMirror {
        height: 100%;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 14px;
    }

    .console-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 14px;
        height: 400px;
        display: flex;
        flex-direction: column;
        border-radius: 4px;
        border: 1px solid #2d2d2d;
        overflow: hidden;
    }

    #consoleOutput {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .console-input-line {
        display: flex;
        align-items: center;
        padding: 5px;
        border-top: 1px solid #2d2d2d;
        background-color: #1e1e1e;
    }

    .console-prompt {
        color: #569cd6;
        margin-right: 8px;
        user-select: none;
        padding: 0 8px;
    }

    #consoleInput {
        background: transparent;
        border: none;
        color: #d4d4d4;
        font-family: inherit;
        font-size: inherit;
        width: 100%;
        outline: none;
        padding: 8px;
    }

    /* Rest of your existing styles */
    .confidence-btn {
        width: 18%;
        transition: all 0.3s ease;
        position: relative;
    }

    .confidence-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }

    .confidence-btn.selected {
        background-color: #007bff;
        color: white;
        transform: translateY(-2px);
    }

    .confidence-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 8px;
        background-color: #343a40;
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }

    .confidence-btn:hover .confidence-tooltip {
        opacity: 1;
        visibility: visible;
        bottom: 120%;
    }

    .code-editor {
        height: 400px;
        border: 1px solid #2d2d2d;
    }

    .console-output {
        height: 200px;
        padding: 1rem;
        background-color: #1a1a1a;
        font-family: monospace;
        overflow-y: auto;
    }

    .solution-card {
        background-color: #2d2d2d;
        border: 1px solid #3d3d3d;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .solution-card .card-header {
        background-color: #343a40;
        border-bottom: 1px solid #3d3d3d;
    }

    .progress {
        height: 8px;
        background-color: #2d2d2d;
    }

    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* New styles for learning scaffolding */
    .cognitive-level-indicator {
        background-color: #2d2d2d;
        border-left: 4px solid #007bff;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .task-breakdown {
        background-color: #2d2d2d;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .task-step {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        background-color: #363636;
    }

    .task-step.completed {
        background-color: #28a745;
        opacity: 0.8;
    }

    .reflection-prompt {
        background-color: #343a40;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-top: 1rem;
    }

    .hint-panel {
        background-color: #2d2d2d;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .hint-content {
        display: none;
        padding: 0.5rem;
        margin-top: 0.5rem;
        background-color: #363636;
        border-radius: 4px;
    }

    .hint-content.visible {
        display: block;
    }

    .feedback-panel {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 300px;
        background-color: #2d2d2d;
        border-radius: 4px;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        display: none;
    }

    .feedback-panel.visible {
        display: block;
    }

    /* New styles from edited snippet */
    .step-indicators {
        display: flex;
        gap: 8px;
    }

    .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #2d2d2d;
        transition: background-color 0.3s;
    }

    .indicator.active {
        background-color: #28a745;
    }

    .reflection-feedback {
        padding: 8px;
        border-radius: 4px;
        background-color: #2d2d2d;
    }

    .strategy-selector select {
        background-color: #2d2d2d;
        border: 1px solid #3d3d3d;
    }

    .task-step {
        background-color: #2d2d2d;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        transition: all 0.3s;
    }

    .task-step:hover {
        background-color: #3d3d3d;
    }

    .step-content {
        display: flex;
        flex-direction: column;
    }

    .step-title {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .curriculum-level-indicator {
        background-color: #2d2d2d;
        border-left: 4px solid #007bff; /* Blue border */
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .curriculum-objectives {
        margin-top: 1rem;
    }
    .curriculum-objectives p {
        margin-bottom: 0.5rem; /* Adjust spacing as needed */
    }
    .curriculum-level-indicator .current-level {
        background-color: #343a40;
        padding: 15px;
        border-radius: 4px;
    }

    /* Update container related styles */
    .container-fluid {
        padding: 0;
        margin: 0;
        max-width: 100%;
        overflow-x: hidden;
    }

    .row {
        margin: 0;
        padding: 0;
        width: 100%;
    }

    .col-md-4, .col-md-8 {
        padding: 10px;  /* Add minimal padding for content spacing */
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Column: Learning Journey -->
        <div class="col-md-4">
            <div class="card mb-3 bg-dark text-light border-secondary">
                <div class="card-body">
                    <!-- Curriculum Level Indicator -->
                    <div class="curriculum-level-indicator mb-4">
                        <h4 class="text-primary">
                            {% if lang == 'fr' %}Niveau du Programme{% else %}Curriculum Level{% endif %}
                        </h4>
                        <div class="current-level p-3 bg-secondary rounded">
                            <h5 class="mb-2">
                                {% if curriculum == 'ICS4U' %}
                                    {% if lang == 'fr' %}12e année - C# Avancé (ICS4U){% else %}Grade 12 - Advanced C# (ICS4U){% endif %}
                                {% elif curriculum == 'ICS3U' %}
                                    {% if lang == 'fr' %}11e année - C# (ICS3U){% else %}Grade 11 - C# (ICS3U){% endif %}
                                {% elif curriculum == 'ICS2O' %}
                                    {% if lang == 'fr' %}10e année - C# (ICS2O){% else %}Grade 10 - C# (ICS2O){% endif %}
                                {% elif curriculum == 'TEJ2O' %}
                                    {% if lang == 'fr' %}10e année - C++ (TEJ2O){% else %}Grade 10 - C++ (TEJ2O){% endif %}
                                {% endif %}
                            </h5>
                            <div class="curriculum-objectives">
                                <p class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>
                                    {% if lang == 'fr' %}Adapté à votre niveau{% else %}Adapted to your level{% endif %}
                                </p>
                                <p class="mb-0"><i class="bi bi-arrow-up-circle-fill text-info me-2"></i>
                                    {% if lang == 'fr' %}Progression personnalisée{% else %}Personalized progression{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Cognitive Level Indicator -->
                    <div class="cognitive-level-indicator">
                        <h4 class="text-primary">
                            {% if lang == 'fr' %}Processus d'Apprentissage{% else %}Learning Process{% endif %}
                        </h4>
                        <div class="current-level mb-3">
                            <i class="bi bi-diagram-3"></i>
                            <span id="cognitiveLevelText">
                                {% if lang == 'fr' %}Analyse{% else %}Analysis{% endif %}
                            </span>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="cognitionProgress"></div>
                            </div>
                        </div>

                        <!-- New: Metacognitive Strategy Selector -->
                        <div class="strategy-selector mb-3">
                            <h5 class="text-secondary">
                                {% if lang == 'fr' %}Stratégie d'Apprentissage{% else %}Learning Strategy{% endif %}
                            </h5>
                            <select class="form-select bg-dark text-light" id="strategySelect">
                                <option value="visual">{% if lang == 'fr' %}Visuel{% else %}Visual Learner{% endif %}</option>
                                <option value="verbal">{% if lang == 'fr' %}Verbal{% else %}Verbal Learner{% endif %}</option>
                                <option value="active">{% if lang == 'fr' %}Pratique{% else %}Active Learner{% endif %}</option>
                            </select>
                        </div>

                        <!-- Enhanced Task Breakdown with Process Indicators -->
                        <div class="task-breakdown">
                            <h4 class="text-primary">
                                {% if lang == 'fr' %}Progression de la Pensée{% else %}Thinking Progress{% endif %}
                            </h4>
                            <div id="taskSteps">
                                <!-- Task steps will be populated dynamically based on curriculum level -->
                            </div>
                        </div>

                        <!-- Enhanced Reflection Section with Adaptive Prompts -->
                        <div class="reflection-prompt">
                            <h4 class="text-warning">
                                {% if lang == 'fr' %}Réflexion Active{% else %}Active Reflection{% endif %}
                            </h4>
                            <div id="reflectionArea">
                                <div class="reflection-question mb-2" id="currentPrompt"></div>
                                <textarea class="form-control bg-dark text-light mb-2"
                                          id="reflectionResponse"
                                          rows="3"
                                          placeholder="{% if lang == 'fr' %}Votre réflexion ici...{% else %}Your reflection here...{% endif %}">
                                </textarea>
                                <div class="reflection-feedback mt-2 d-none" id="reflectionFeedback"></div>
                            </div>
                        </div>

                        <!-- New: Actionable Feedback Panel -->
                        <div class="feedback-panel mt-3">
                            <h4 class="text-info">
                                {% if lang == 'fr' %}Suggestions d'Amélioration{% else %}Improvement Suggestions{% endif %}
                            </h4>
                            <div id="actionableFeedback" class="p-2 rounded">
                                <!-- Feedback will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>


                    <!-- Confidence Assessment -->
                    <div class="confidence-prediction mb-4">
                        <h4 class="text-primary">
                            {% if lang == 'fr' %}Auto-évaluation{% else %}Self-Assessment{% endif %}
                        </h4>
                        <div class="confidence-buttons d-flex justify-content-between mb-3">
                            {% for i in range(1, 6) %}
                            <button type="button"
                                    class="btn btn-outline-primary confidence-btn position-relative"
                                    data-value="{{ i }}">
                                {{ i }}
                                <span class="confidence-tooltip">
                                    {% if lang == 'fr' %}
                                        {{ 'Pas du tout confiant' if i == 1 else 'Peu confiant' if i == 2 else 'Moyennement confiant' if i == 3 else 'Assez confiant' if i == 4 else 'Très confiant' }}
                                    {% else %}
                                        {{ 'Not at all confident' if i == 1 else 'Slightly confident' if i == 2 else 'Moderately confident' if i == 3 else 'Quite confident' if i == 4 else 'Very confident' }}
                                    {% endif %}
                                </span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Hint Panel -->
                    <div class="hint-panel">
                        <h4 class="text-primary">
                            {% if lang == 'fr' %}Indices Adaptatifs{% else %}Adaptive Hints{% endif %}
                        </h4>
                        <div id="hintContainer">
                            <!-- Hints will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Code Editor and Console -->
        <div class="col-md-8">
            <div class="card mb-3 bg-dark text-light border-secondary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        {% if lang == 'fr' %}Éditeur de Code{% else %}Code Editor{% endif %}
                    </h4>
                    <div class="btn-group">
                        <button id="runCode" class="btn btn-primary">
                            <i class="bi bi-play-fill"></i>
                            {% if lang == 'fr' %}Exécuter{% else %}Run{% endif %}
                        </button>
                        <button id="resetCode" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            {% if lang == 'fr' %}Réinitialiser{% else %}Reset{% endif %}
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="editor-container">
                        <textarea id="editor">{{ activity.starter_code }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Console Output -->
            <div class="card bg-dark text-light border-secondary console-container">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        {% if lang == 'fr' %}Console{% else %}Console{% endif %}
                    </h4>
                    <button id="clearConsole" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="consoleOutput" class="console-output"></div>
                    <div class="console-input-line">
                        <span class="console-prompt">>>> </span>
                        <input type="text" id="consoleInput" placeholder="Enter command...">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Feedback Panel -->
<div class="feedback-panel" id="feedbackPanel">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0 text-light">Feedback</h5>
        <button type="button" class="btn-close btn-close-white" onclick="closeFeedbackPanel()"></button>
    </div>
    <div id="feedbackContent" class="text-light"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Required scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Load console.js before editor.js -->
<script src="{{ url_for('static', filename='js/console.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>

<script>
// Initialize lang variable from meta tag
const lang = document.querySelector('meta[name="interface-lang"]').content;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: 'text/x-c++src',
        theme: 'dracula',
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 4,
        tabSize: 4,
        lineWrapping: true,
        viewportMargin: Infinity,
        extraKeys: {
            "Tab": function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection("    ", "end");
                }
            }
        }
    });

    // Initialize Console
    const consoleOutput = document.getElementById('consoleOutput');
    const consoleInput = document.getElementById('consoleInput');

    function appendToConsole(text, className = '') {
        const div = document.createElement('div');
        div.className = className;
        div.textContent = text;
        consoleOutput.appendChild(div);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    // Run Code Handler
    document.getElementById('runCode').addEventListener('click', function() {
        const code = editor.getValue();
        consoleInput.disabled = true;
        appendToConsole('Running code...', 'console-info');

        fetch('/activities/run_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                code: code,
                activity_id: '{{ activity.id }}',
                language: '{{ activity.language }}'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.output) {
                    appendToConsole(data.output, 'console-output');
                }
            } else {
                appendToConsole('Error: ' + (data.error || 'Unknown error'), 'console-error');
            }
            consoleInput.disabled = false;
        })
        .catch(error => {
            appendToConsole('Error executing code: ' + error.message, 'console-error');
            consoleInput.disabled = false;
        });
    });

    // Clear Console Handler
    document.getElementById('clearConsole').addEventListener('click', function() {
        consoleOutput.innerHTML = '';
    });

    // Confidence Button Handling
    const confidenceButtons = document.querySelectorAll('.confidence-btn');
    confidenceButtons.forEach(button => {
        button.addEventListener('click', function() {
            const confidence = this.dataset.value;

            // Visual feedback
            confidenceButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');

            // Store confidence level
            fetch('/activities/store_confidence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    activity_id: '{{ activity.id }}',
                    confidence_level: confidence
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Update progress bar
                      updateProgress();
                  }
              });
        });
    });

    // Solution Comparison Loading
    function loadSolutionComparisons() {
        fetch(`/activities/get_solutions/{{ activity.id }}`)
            .then(response => response.json())
            .then(solutions => {
                const container = document.getElementById('solutionApproaches');
                container.innerHTML = ''; // Clear existing solutions

                solutions.forEach((solution, index) => {
                    const card = document.createElement('div');
                    card.className = 'solution-card mb-3';
                    card.innerHTML = `
                        <div class="card-header">
                            <h5 class="mb-0">
                                ${lang === 'fr' ? 'Solution ' : 'Solution '} ${index + 1}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p>${solution.approach_description}</p>
                            <div class="d-flex justify-content-between text-muted">
                                <span>
                                    ${lang === 'fr' ? 'Efficacité' : 'Efficiency'}: ${solution.efficiency_score}
                                </span>
                                <span>
                                    ${lang === 'fr' ? 'Mémoire' : 'Memory'}: ${solution.memory_usage}MB
                                </span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
    }

    // Update progress bar
    function updateProgress() {
        // This is a placeholder for progress calculation
        const progress = document.getElementById('progressBar');
        let currentWidth = parseInt(progress.style.width) || 0;
        progress.style.width = Math.min(currentWidth + 20, 100) + '%';
    }

    // Initialize Task Breakdown
    const curriculumLevel = '{{ curriculum }}';
    const taskSteps = {
        'ICS4U': [
            { id: 1, text: lang === 'fr' ? 'Analyse avancée du problème' : 'Advanced Problem Analysis' },
            { id: 2, text: lang === 'fr' ? 'Conception de solution optimisée' : 'Optimized Solution Design' },
            { id: 3, text: lang === 'fr' ? 'Implémentation avec structures avancées' : 'Implementation with Advanced Structures' },
            { id: 4, text: lang === 'fr' ? 'Tests et optimisation' : 'Testing and Optimization' }
        ],
        'ICS3U': [
            { id: 1, text: lang === 'fr' ? 'Analyse du problème' : 'Problem Analysis' },
            { id: 2, text: lang === 'fr' ? 'Planification de la solution' : 'Solution Planning' },
            { id: 3, text: lang === 'fr' ? 'Implémentation structurée' : 'Structured Implementation' },
            { id: 4, text: lang === 'fr' ? 'Tests et débogage' : 'Testing and Debugging' }
        ],
        'ICS2O': [
            { id: 1, text: lang === 'fr' ? 'Comprendre les exigences' : 'Understanding Requirements' },
            { id: 2, text: lang === 'fr' ? 'Création du programme' : 'Program Creation' },
            { id: 3, text: lang === 'fr' ? 'Test du code' : 'Code Testing' }
        ],
        'TEJ2O': [
            { id: 1, text: lang === 'fr' ? 'Comprendre la syntaxe C++' : 'Understanding C++ Syntax' },
            { id: 2, text: lang === 'fr' ? 'Écriture du programme' : 'Program Writing' },
            { id: 3, text: lang === 'fr' ? 'Vérification du code' : 'Code Verification' }
        ]
    };

    function updateTaskSteps() {
        const container = document.getElementById('taskSteps');
        const steps = taskSteps[curriculumLevel] || taskSteps['ICS2O']; // Default to ICS2O if level not found

        container.innerHTML = steps.map(step => `
            <div class="task-step">
                <div class="step-content">
                    <span class="step-title">${step.text}</span>
                    <div class="step-indicators d-flex mt-1">
                        <span class="indicator" data-type="read"></span>
                        <span class="indicator" data-type="analyze"></span>
                        <span class="indicator" data-type="question"></span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Initialize Reflection Prompts
    const reflectionPrompts = [
        lang === 'fr' ?
            'Quelle partie du problème trouvez-vous la plus difficile ?' :
            'Which part of the problem do you find most challenging?',
        lang === 'fr' ?
            'Comment avez-vous décomposé ce problème ?' :
            'How did you break down this problem?',
        lang === 'fr' ?
            'Quelle stratégie utilisez-vous pour déboguer votre code ?' :
            'What strategy are you using to debug your code?'
    ];

    function updateReflectionPrompt() {
        const prompt = document.getElementById('currentPrompt');
        prompt.textContent = reflectionPrompts[Math.floor(Math.random() * reflectionPrompts.length)];
    }

    // Adaptive Hint System
    function showHint(level) {
        const hintContainer = document.getElementById('hintContainer');
        const hints = {
            1: lang === 'fr' ?
                'Commencez par comprendre les entrées et sorties requises.' :
                'Start by understanding the required inputs and outputs.',
            2: lang === 'fr' ?
                'Pensez à décomposer le problème en plus petites étapes.' :
                'Consider breaking down the problem into smaller steps.',
            3: lang === 'fr' ?
                'Vérifiez les cas limites dans votre solution.' :
                'Check for edge cases in your solution.'
        };

        const hint = hints[level] || hints[1];
        const hintElement = document.createElement('div');
        hintElement.className = 'hint-content visible';
        hintElement.textContent = hint;
        hintContainer.appendChild(hintElement);
    }

    // Real-time Feedback
    function showFeedback(message, type = 'info') {
        const panel = document.getElementById('feedbackPanel');
        const content = document.getElementById('feedbackContent');
        content.textContent = message;
        panel.classList.add('visible');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            panel.classList.remove('visible');
        }, 5000);
    }

    function closeFeedbackPanel() {
        document.getElementById('feedbackPanel').classList.remove('visible');
    }

    // Initial load
    loadSolutionComparisons();
    updateTaskSteps();
    updateReflectionPrompt();

    // Initialize metacognitive components from edited snippet
    const reflectionPrompts2 = {
        understanding: [
            lang === 'fr' ?
                'Comment approchez-vous ce problème différemment des précédents ?' :
                'How are you approaching this problem differently from previous ones?',
            lang === 'fr' ?
                'Quelles connexions faites-vous avec des concepts déjà appris ?' :
                'What connections are you making with previously learned concepts?'
        ],
        planning: [
            lang === 'fr' ?
                'Quelle est votre stratégie pour décomposer ce problème ?' :
                'What is your strategy for breaking down this problem?',
            lang === 'fr' ?
                'Comment savez-vous si votre approche est efficace ?' :
                'How do you know if your approach is effective?'
        ],
        reflection: [
            lang === 'fr' ?
                'Quels aspects de votre solution pourraient être améliorés ?' :
                'Which aspects of your solution could be improved?',
            lang === 'fr' ?
                'Comment cette activité a-t-elle changé votre compréhension ?' :
                'How has this activity changed your understanding?'
        ]
    };

    function updateReflectionPrompt2(stage) {
        const prompts = reflectionPrompts2[stage];
        const promptEl = document.getElementById('currentPrompt');
        promptEl.textContent = prompts[Math.floor(Math.random() * prompts.length)];
    }

    // Initialize with understanding prompts
    updateReflectionPrompt2('understanding');


    // Handle strategy selection
    document.getElementById('strategySelect').addEventListener('change', function(e) {
        const strategy = e.target.value;
        // Adapt interface based on learning strategy
        adaptInterface(strategy);
    });

    function adaptInterface(strategy) {
        // Modify interface elements based on learning strategy
        const hintContainer = document.getElementById('hintContainer');
        switch(strategy) {
            case 'visual':
                // Show more diagrams, flowcharts
                break;
            case 'verbal':
                // Show more text explanations
                break;
            case 'active':
                // Show more interactive elements
                break;
        }
    }

    // Monitor reflection responses
    document.getElementById('reflectionResponse').addEventListener('input', function(e) {
        const response = e.target.value;
        if (response.length > 50) {
            // Provide feedback based on response content
            provideFeedback(response);
        }
    });

    function provideFeedback(response) {
        const feedbackEl = document.getElementById('reflectionFeedback');
        feedbackEl.classList.remove('d-none');
        // Analyze response and provide appropriate feedback
        feedbackEl.textContent = lang === 'fr' ?
            'Bonne réflexion ! Pensez aussi à...' :
            'Good reflection! Consider also...';
    }
});
</script>
{% endblock %}