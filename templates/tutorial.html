{% extends "base.html" %}

{% block extra_head %}
<style>
    .tutorial-container {
        display: flex;
        height: calc(100vh - 56px);
    }
    .tutorial-sidebar {
        width: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: var(--bs-dark);
        border-right: 1px solid var(--bs-border-color);
    }
    .editor-container {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .step-content {
        margin-bottom: 1rem;
    }
    .step-navigation {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--bs-border-color);
    }
    .current-step {
        background: var(--bs-primary-bg-subtle);
        border-left: 4px solid var(--bs-primary);
        padding-left: 1rem;
    }
    .completed-step {
        color: var(--bs-success);
    }
    .code-snippet {
        background: var(--bs-dark);
        padding: 1rem;
        border-radius: 0.375rem;
        margin: 1rem 0;
    }
    .hint-container {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--bs-warning-bg-subtle);
        border-radius: 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="tutorial-container">
    <div class="tutorial-sidebar">
        <h3>{{ activity.title }}</h3>
        <p class="text-muted">{{ activity.description }}</p>
        
        <div class="progress mb-3" style="height: 20px;">
            <div class="progress-bar" role="progressbar" 
                 style="width: {{ (current_step / total_steps * 100)|round }}%;"
                 aria-valuenow="{{ current_step }}" 
                 aria-valuemin="0" 
                 aria-valuemax="{{ total_steps }}">
                Étape {{ current_step }}/{{ total_steps }}
            </div>
        </div>

        <div class="step-content">
            <h4>{{ current_tutorial_step.title }}</h4>
            <div class="mb-3">
                {{ current_tutorial_step.content|safe }}
            </div>
            
            {% if current_tutorial_step.code_snippet %}
            <div class="code-snippet">
                <pre><code>{{ current_tutorial_step.code_snippet }}</code></pre>
            </div>
            {% endif %}

            {% if current_tutorial_step.expected_output %}
            <div class="mb-3">
                <h5>Sortie attendue:</h5>
                <pre>{{ current_tutorial_step.expected_output }}</pre>
            </div>
            {% endif %}

            {% if show_hint %}
            <div class="hint-container">
                <h5><i class="bi bi-lightbulb"></i> Indice:</h5>
                <p>{{ current_tutorial_step.hint }}</p>
            </div>
            {% endif %}
        </div>

        <div class="step-navigation">
            <div class="d-flex justify-content-between">
                {% if prev_step %}
                <a href="{{ url_for('tutorial', activity_id=activity.id, step=current_step-1) }}" 
                   class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Précédent
                </a>
                {% endif %}

                {% if not show_hint and current_tutorial_step.hint %}
                <button class="btn btn-warning" onclick="showHint()">
                    <i class="bi bi-lightbulb"></i> Voir l'indice
                </button>
                {% endif %}

                {% if next_step %}
                <a href="{{ url_for('tutorial', activity_id=activity.id, step=current_step+1) }}" 
                   class="btn btn-primary {% if not step_completed %}disabled{% endif %}">
                    Suivant <i class="bi bi-arrow-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="editor-container">
        <div id="editor" style="width: 100%; height: 70%;"></div>
        <div class="p-3">
            <button class="btn btn-success" onclick="runCode()">
                <i class="bi bi-play-fill"></i> Exécuter
            </button>
            <button class="btn btn-primary" onclick="verifyStep()">
                <i class="bi bi-check2-circle"></i> Vérifier l'étape
            </button>
        </div>
        <div id="output" class="p-3 bg-dark" style="height: 30%; overflow-y: auto;">
            <pre id="output-content"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let editor;
    let showHint = false;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `{{ activity.starter_code|safe }}`,
                language: '{{ activity.language }}',
                theme: 'vs-dark',
                automaticLayout: true
            });
        });
    });

    function showHint() {
        window.location.href = `{{ url_for('tutorial', activity_id=activity.id, step=current_step) }}?hint=true`;
    }

    async function runCode() {
        const code = editor.getValue();
        const response = await fetch('{{ url_for("execute") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                code: code,
                language: '{{ activity.language }}'
            })
        });
        const result = await response.json();
        document.getElementById('output-content').textContent = result.output || result.error;
    }

    async function verifyStep() {
        const code = editor.getValue();
        const response = await fetch('{{ url_for("verify_tutorial_step", activity_id=activity.id, step=current_step) }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });
        const result = await response.json();
        
        if (result.success) {
            alert('Excellent! Vous pouvez passer à l\'étape suivante.');
            location.reload();
        } else {
            alert('Pas tout à fait correct. Essayez encore!');
        }
    }
</script>
{% endblock %}
